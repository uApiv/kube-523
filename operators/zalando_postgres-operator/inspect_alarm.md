# Inspect the result of alarms

## 1. testrun-2024-02-23-16-45/trial-00-0001/0004

```json
{
    "testcase": {
        "field": "[\"spec\", \"patroni\"]",
        "testcase": "object-deletion"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-00-0001",
        "generation": 4
    },
    "oracle_result": {
        "crash": null,
        "health": null,
        "operator_log": null,
        "consistency": {
            "message": "Found no matching fields for input",
            "input_diff": {
                "prev": "ACTOKEY",
                "curr": "NotPresent",
                "path": {
                    "path": [
                        "spec",
                        "patroni",
                        "initdb",
                        "ACTOKEY"
                    ]
                }
            },
            "system_state_diff": null
        },
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}
```

This alarm is generated by the deletion of the `ACTOKEY` field in the
`spec.patroni.ipkg/cluster/k8sres.gonitdb` object. Although the `ACTOKEY`
is deleted, the `ACTOKEY` is still present in the system state file.

This may be a True alarm. The related source code is at `pkg/cluster/k8sres.go:418`.
It seems that they just append the `initdb` value to the existing one. To
ultimately determine if this is a true alarm, we may need to rerun the test and
debug the changes.


## 2. testrun-2024-02-23-16-45/trial-00-0003/0001

```json
{
    "testcase": {
        "field": "[\"spec\", \"tls\", \"secretName\"]",
        "testcase": "string-deletion"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-00-0003",
        "generation": 1
    },
    "oracle_result": {
        "crash": null,
        "health": {
            "message": "statefulset: test-cluster replicas [1] ready_replicas [1]"
        },
        "operator_log": null,
        "consistency": null,
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}
```

False alarm. From the corresponding event.json, there is the log:

> "message": "create Pod test-cluster-1 in StatefulSet test-cluster failed error: Pod \"test-cluster-1\" is invalid: [spec.volumes[2].name: Invalid value: \"ACTOKEY\": a lowercase RFC 1123 label must consist of lower case alphanumeric characters or '-', and must start and end with an alphanumeric character (e.g. 'my-name',  or '123-abc', regex used for validation is '[a-z0-9]([-a-z0-9]*[a-z0-9])?'), spec.containers[0].volumeMounts[2].name: Not found: \"ACTOKEY\"]",

This means that the ACTOKEY is not a valid name because it doesn't follow the naming convention.


## 3. testrun-2024-02-23-16-45/trial-00-0004/0001

```json
{
    "testcase": {
        "field": "[\"spec\", \"tls\", \"secretName\"]",
        "testcase": "string-change"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-00-0004",
        "generation": 1
    },
    "oracle_result": {
        "crash": null,
        "health": {
            "message": "statefulset: test-cluster replicas [1] ready_replicas [1]"
        },
        "operator_log": null,
        "consistency": null,
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}
```

Same as No.2.

## 4. testrun-2024-02-23-16-45/trial-00-0005/0002

```json
{
    "testcase": {
        "field": "[\"spec\", \"tolerations\", 0, \"operator\"]",
        "testcase": "Equal"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-00-0005",
        "generation": 2
    },
    "oracle_result": {
        "crash": null,
        "health": {
            "message": "statefulset: test-cluster replicas [1] ready_replicas [1]"
        },
        "operator_log": null,
        "consistency": null,
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}
```

Similar to No.2. False alarm.

The error message is:

> "message": "create Pod test-cluster-1 in StatefulSet test-cluster failed error: Pod \"test-cluster-1\" is invalid: spec.tolerations[0].operator: Invalid value: \"Equal\": operator must be Exists when `key` is empty, which means \"match all values and all keys\"",

This means that the `operator` field must be `Exists` when the `key` is empty.
Acto's mutation doesn't follow the constraint.

## 5. testrun-2024-02-23-16-45/trial-00-0010/0002
```json
{
    "testcase": {
        "field": "[\"spec\", \"streams\", 0, \"tables\", \"ACTOKEY\", \"eventType\"]",
        "testcase": "string-deletion"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-00-0010",
        "generation": 2
    },
    "oracle_result": {
        "crash": null,
        "health": null,
        "operator_log": null,
        "consistency": {
            "message": "Found no matching fields for input",
            "input_diff": {
                "prev": "ACTOKEY",
                "curr": "",
                "path": {
                    "path": [
                        "spec",
                        "streams",
                        0,
                        "tables",
                        "ACTOKEY",
                        "eventType"
                    ]
                }
            },
            "system_state_diff": null
        },
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}

```

False alarm. The Acto should not report this alarm because the `eventType` field
does change from `ACTOKEY` to  `""` in the system state file.


## 6. testrun-2024-02-23-16-45/trial-00-0011/0003

```json
{
    "testcase": {
        "field": "[\"spec\", \"streams\", 0, \"tables\", \"ACTOKEY\", \"eventType\"]",
        "testcase": "string-empty"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-00-0011",
        "generation": 3
    },
    "oracle_result": {
        "crash": null,
        "health": null,
        "operator_log": null,
        "consistency": {
            "message": "Found no matching fields for input",
            "input_diff": {
                "prev": "ACTOKEY",
                "curr": "",
                "path": {
                    "path": [
                        "spec",
                        "streams",
                        0,
                        "tables",
                        "ACTOKEY",
                        "eventType"
                    ]
                }
            },
            "system_state_diff": null
        },
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}
```
Same as No.5.

## 7. testrun-2024-02-23-16-45/trial-01-0002/0001
```json
{
    "testcase": {
        "field": "[\"spec\", \"tolerations\", 0, \"effect\"]",
        "testcase": "NoSchedule"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-01-0002",
        "generation": 1
    },
    "oracle_result": {
        "crash": null,
        "health": {
            "message": "statefulset: test-cluster replicas [1] ready_replicas [1]"
        },
        "operator_log": null,
        "consistency": null,
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}
```

Same to No.4. False alarm.

The error message is:

> "message": "create Pod test-cluster-1 in StatefulSet test-cluster failed error: Pod \"test-cluster-1\" is invalid: spec.tolerations[0].operator: Invalid value: \"\": operator must be Exists when `key` is empty, which means \"match all values and all keys\"",

This means that the `operator` field must be `Exists` when the `key` is empty.

## 8. testrun-2024-02-23-16-45/trial-01-0003/0001
```json
{
    "testcase": {
        "field": "[\"spec\", \"tolerations\", 0, \"effect\"]",
        "testcase": "PreferNoSchedule"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-01-0003",
        "generation": 1
    },
    "oracle_result": {
        "crash": null,
        "health": {
            "message": "statefulset: test-cluster replicas [1] ready_replicas [1]"
        },
        "operator_log": null,
        "consistency": null,
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}
```

Same to No.4. False alarm.

## 9. testrun-2024-02-23-16-45/trial-01-0007/0002

```json
{
    "testcase": {
        "field": "[\"spec\", \"masterServiceAnnotations\"]",
        "testcase": "object-deletion"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-01-0007",
        "generation": 2
    },
    "oracle_result": {
        "crash": null,
        "health": null,
        "operator_log": null,
        "consistency": {
            "message": "Found no matching fields for input",
            "input_diff": {
                "prev": "ACTOKEY",
                "curr": "NotPresent",
                "path": {
                    "path": [
                        "spec",
                        "masterServiceAnnotations",
                        "ACTOKEY"
                    ]
                }
            },
            "system_state_diff": null
        },
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}
```
True alarm. The `ACTOKEY` is deleted from the `masterServiceAnnotations` field
in the new config file, but it is still present in the system state file.

The corresponding source code is at `pkg/cluster/k8sres.go:2039`:

```go
if spec != nil {
	maps.Copy(annotations, spec.ServiceAnnotations)

	switch role {
	case Master:
		maps.Copy(annotations, spec.MasterServiceAnnotations)
	case Replica:
		maps.Copy(annotations, spec.ReplicaServiceAnnotations)
	}
}
```
In GoLang, the implementation of `maps.Copy` is:
```go
func Copy[M1 ~map[K]V, M2 ~map[K]V, K comparable, V any](dst M1, src M2) {
	for k, v := range src {
		dst[k] = v
	}
}
```

It won't delete the existing key-value pairs in the `dst` map. It just appends
or updates the `dst` map with the `src` map.

So that, `maps.Copy` will not delete the `ACTOKEY` from the `masterServiceAnnotations` field.
It's a true alarm.

## 10. testrun-2024-02-23-16-45/trial-01-0008/0005

```json
{
    "testcase": {
        "field": "[\"spec\", \"resources\", \"requests\", \"cpu\"]",
        "testcase": "string-change"
    },
    "step_id": {
        "trial": "testrun-2024-02-23-16-45/trial-01-0008",
        "generation": 5
    },
    "oracle_result": {
        "crash": null,
        "health": {
            "message": "statefulset: test-cluster replicas [1] ready_replicas [1]"
        },
        "operator_log": null,
        "consistency": null,
        "differential": null,
        "custom": null
    },
    "cli_status": "Pass",
    "is_revert": false
}
```
False alarm. The `cpu` field is changed from `7m` to `427385m` in the system state file.
However, the `cpu` field is limited to `100000m` by default.
